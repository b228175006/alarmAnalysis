# 历史告警数据分析实现设计
[TOC]
## 1.概述
根据[《历史告警数据分析需求设计》](https://github.com/roysong/alarmAnalysis/blob/master/alarmRequire.md)中对“告警数据场景分析”的需求进行数据清洗和挖掘的方法的设计

## 2.数据来源及字段

### 2.1.数据来源
总体历史告警数据目前有800W+条，从中拆分为挖掘测试数据集和知识验证数据集，现已按照设备对告警数据进行了拆分，从中选取了20W条左右的告警信息作为挖掘测试数据集，用于验证挖掘过程和发现知识。
选取的数据集为 99服务器上的`analysis_roy.huawei_wgkz_gsg`

### 2.2.数据字段

|字段名           |含义        |
|-----------------|------------|
|ALARMTIMES_      |告警次数    |
|ALARM_RESOURCE   |告警资源    |
|ALM_DESC_        |告警描述    |
|ALM_ID_          |告警ID      |
|ALM_LEVEL_ID_    |告警等级ID  |
|ALM_NAME_        |告警名称    |
|ALM_NAME_DESC    |告警名称描述|
|ALM_OBJECT_      |告警对象    |
|ALM_TYPE_ID_     |告警类型ID  |
|CONFIRM_STATE_   |确认状态    |
|CONFIRM_USERNAME |确认人名    |
|CONFRIM_TIME_    |确认时间    |
|DELETE_TIME_     |删除时间    |
|DELETE_USERNAME  |删除人      |
|DEVICE_ID_       |设备ID      |
|EMS_ID_          |EMS ID      |
|FIRST_OCCUR_     |首次发生时间|
|INSERT_TIME_     |入库时间    |
|KEY_VARIABLE_    |告警关键字  |
|LAST_OCCUR_      |最后发生时间|
|RESUME_STATE_    |恢复状态    |
|SPECIALITY_ID_   |所属专业    |

## 3.不同告警数据场景的挖掘方法
告警数据场景有告警压缩、告警过滤、告警抑制、告警计数、告警泛化、告警特化、告警时序关系、超历时告警共8中场景，其中告警泛化、告警特化未涉及数据分析内容，超时告警不在历史告警数据中，所需分析的只有告警压缩、告警过滤、告警抑制、告警计数、告警时序关系。根据数据挖掘中阶段的不同，在不同阶段中进行不同告警数据场景的分析。
数据挖掘的不同阶段分为数据预处理、数据挖掘、模式评估、知识表示四个大的阶段，根据本次需求的设计只使用到了数据预处理、数据挖掘两个阶段。

### 3.1.数据预处理
~~数据预处理中又分为数据清洗、数据集成、数据转换、数据消减4个步骤，在数据清洗过程中，需要通过数据清洗实现`告警压缩`，`告警过滤`两方面的内容，`告警过滤`时，还需实现数据转换的步骤~~

在数据挖掘之前，需要对已有数据集进行处理，得到数据挖掘需要的数据集。
先对已有结果集进行`告警压缩`处理，得到一个较小的中间数据集，然后进行`告警过滤`处理，进一步消减数据集，再对中间数据集的数据进行`属性构造？`，增加下一步处理中需要的资源关联属性，最后对消减后的结果集进行`维数消减`，得到数据挖掘所需的数据集。

#### 3.1.1.告警压缩：
>将发生的多个告警压缩到一个告警中，适用于相同网元，具有相同特征的重复告警，如同一设备在短时间内发送的相同类型的告警。

* 判断标准：
在`首次发生时间一定时间范围内FIRST_OCCUR_`（按经验判断为3s，在压缩过程中需不断迭代，计算出准确值），相同`告警对象ALM_OBJECT_`产生的相同`告警名称ALM_NAME_`且具有相同`关键字（厂家提供的设备原始标识）KEY_VARIABLE_`的告警可判断为重复告警，在此时间段内的重复告警只保留一条
* 输出结果：
告警压缩后的全字段数据集

#### 3.1.2.告警过滤：
> 如果告警代表的含义并非故障，则将其过滤掉，适用于系统配置改变、性能异常等告警形式。

通过关联资源对象`DEVICE_ID_`、告警名称`ALM_NAME_`进行判断此告警数据是否为故障的报警，只保留由故障引起的告警信息

* 判断标准：
    1. 如果告警信息无关联资源对象`DEVICE_ID_`，肯定不是故障告警
    2. 如果告警信息有关联资源对象`DEVICE_ID_`，则判断告警名称`ALM_NAME_`是否为`LOS告警`，是LOS告警可判定为故障告警
* 输出结果：
告警过滤后的全字段数据集

#### 3.1.3.属性构造？
>从oracle数据表中获取资源关系属性（父类设备，与其他设备链接数)，并把关联资源的属性保存到数据集中

* 根据历史告警数据中的`DEVICE_ID_`属性，从ORACLE数据库中获取此告警设备在`RES_RESOURCE_DEVICE （设备资源表）`中的`PARENT_ID_`，对此条告警数据增加父资源关联属性`DEVICE_PARENT_ID_`
* <span style="color:red">?</span>根据历史告警数据中的`DEVICE_ID_`属性，从ORACLE数据库中查询此设备与其他设备的链接关系，对链接数进行统计，对词条告警数据增加链接统计属性`LINK_COUNT_`

输出结果为告警过滤后的数据集，并增加了`DEVICE_PARENT_ID_`、`LINK_COUNT_`字段

#### 3.1.4.维数消减
> 删除与数据挖掘无关的属性

维数消减后数据字段为

|字段名           |含义        |消减原因|
|-----------------|------------|--|
| ~~ALARMTIMES_ ~~     | ~~告警次数~~    |抽样检查后发现大部分字段值相同|
|ALARM_RESOURCE   |告警资源    | |
| ~~ALM_DESC_ ~~       | ~~告警描述~~    |大部分值为‘unknown’|
| ~~ALM_ID_ ~~         | ~~告警ID~~      |告警ID为程序生成的UUID值，无挖掘必要|
|ALM_LEVEL_ID_    |告警等级ID  | |
|ALM_NAME_        |告警名称    | |
| ~~ALM_NAME_DESC~~    | ~~告警名称描述~~ |此字段是给人工识别的结果|
|ALM_OBJECT_      |告警对象    | |
| ALM_TYPE_ID_    | 告警类型ID | |
| CONFIRM_STATE_  | 确认状态   | |
| ~~CONFIRM_USERNAME~~ | ~~确认人名~~    |大部分资源无有效值|
| ~~CONFRIM_TIME_~~    | ~~确认时间~~    |大部分资源无有效值|
|DELETE_TIME_     |删除时间    | |
| ~~DELETE_USERNAME~~  | ~~删除人~~      |大部分值为‘规则删除’ |
|DEVICE_ID_       |设备ID      | |
|EMS_ID_          |EMS ID      | |
|~~FIRST_OCCUR_~~     |~~首次发生时间~~|数据集中此字段有大量噪音 |
|~~INSERT_TIME_ ~~    | ~~入库时间~~   |数据存储时的记录时间，对历史告警分析无意义 |
|KEY_VARIABLE_    |告警关键字  | |
|LAST_OCCUR_      |最后发生时间| |
|RESUME_STATE_    | 恢复状态   | |
|SPECIALITY_ID_   |所属专业    | |
|DEVICE_PARENT_ID_|设备父级ID  | |
|LINK_COUNT_      |与其他资源链接数| |

### 3.2.数据挖掘

#### 3.2.1.告警抑制：
> 在主要告警发生的情况下，抑制次要告警，适用于一条告警（主要告警）出现会产生一条或多条其他告警（次要告警）的主次告警场景。主次告警可分为无资源关系和有资源关系两类。无资源关系的主次告警，指主要告警和次要告警没有资源关联关系，只有业务特征关系。有资源关系的主次告警，指主要告警和次要告警有资源关联关系，如父子网元关系、关联网元关系。

~~目前只进行有资源关系的告警数据进行告警抑制~~

1. 从oracle数据表中获取资源关系属性（自身资源属性，关联资源属性)
2. 寻找入口数据
    * 有资源关联关系的告警数据，根据关联关系确定入口
        - 父子关系网元取父网元为入口
        - 汇聚层网元需要根据各个网元的连接数确定汇聚层网元入口；
            + 对所有网元的链接数进行统计，根据统计结果和实际数据进行对比，确定汇聚层网元判断的最低连接数
            + 根据判断汇聚层网元的最低连接数，确定汇聚层网元告警信息的入口
    * 无资源关联关系的告警数据，按照告警发生时间进行聚类，确定入口（聚类方法）
3. 根据入口告警发生时间的前后范围、同步发生时间进行分组，根据不同的分组时间进行迭代，找出合适时间范围的分组
4. 对分组结果进行匹配，各分组中除去入口告警，其他的单个告警出现频率达到80%，则认为此单个告警和入口告警有关联关系

<!-- ### 4. 告警计数：
> 对重复到达的告警记录次数和设定阈值，适用于相同网元具有相同特征的重复告警。和告警压缩不同的是，此处的特征范围有可能比告警压缩时的特征范围更大，此处的告警发生频次更低、时间跨度更长。

### 5. 告警时序关系：
> 相关告警依赖于告警发生时间顺序，适用于无资源关系、无业务特征关系、仅在时间先后上有关联的告警链。 -->


